
#ARCH?=L200
ARCH?=L350
#ARCH?=n300

APP_BINARY_NAME = eeprom
INST_PATH = /tmp/tftp

MAJOR=2
MINOR=0
REVER=1
SVNVER=`sed -n -e 11p .svn/entries`

TOP_PATH = $(shell pwd)

#LDFLAGS+=-lpthread
#CFLAGS+=-Werror -Wall

MODE=PRODUCTION
DEBUG=1

ifeq ("${MODE}", "PRODUCTION")
	CFLAGS+=-DPRODUCTION_MODE
endif
ifdef DEBUG
	CFLAGS+=-g -DDEBUG
else
	CFLAGS+=-O2
	COMPRESS=$(STRIP)
endif

PLAT=$(shell echo $(ARCH) | tr "[a-z]" "[A-Z]")

# ==================================
# ** ARCH SETTINGS FOR L100, L200 **
# ==================================

TMP=${PLAT}
ifneq (,$(filter L100 L200 L200OPT,$(TMP)))
	CROSS_COMPILE=/usr/local/arm_tools_3.3/bin/arm-elf-
	CONFIGURE_ARCH=--host=arm-elf --build=i386
	COMPRESS=flthdr -z -r -s 16384
	CFLAGS+=-DPLAT_L200
	CFLAGS+=-DARCH_${PLAT}
	CFLAGS+=-DCPU_W90P710
	CFLAGS+=-DUCLINUX -DIS_LITTLE_ENDIAN -D_GNU_SOURCE -D_REENTRANT -D_LARGE_THREADS -D_THREAD_SAFE
	LDFLAGS+=-Wl,-elf2flt
	PLATOS=UCLINUX
endif

# ==================================
# ** ARCH SETTINGS FOR L200ARM9   **
# ==================================

TMP=${PLAT}
ifeq ($(TMP), L200ARM9)
	CROSS_COMPILE=arm-linux-uclibc-
	CONFIGURE_ARCH=--host=arm-linux --build=i386
	CFLAGS+=-DPLAT_L200ARM9
	CFLAGS+=-DARCH_${PLAT}
	CFLAGS+=-DCPU_AT91SAM9260
	CFLAGS+=-DLINUX -DIS_LITTLE_ENDIAN -D_GNU_SOURCE -D_REENTRANT -D_LARGE_THREADS -D_THREAD_SAFE
	LDFLAGS+=-ldl
	PLATOS=LINUX
endif

# ==================================
# ** ARCH SETTINGS FOR L300, L350 **
# ==================================

TMP=${PLAT}
ifneq (,$(filter L300 L350,$(TMP)))
	CROSS_COMPILE=/opt/buildroot_350/build_arm/staging_dir/bin/arm-linux-
	CONFIGURE_ARCH=--host=arm-linux --build=i386
	CFLAGS+=-DPLAT_L300
	CFLAGS+=-DARCH_${PLAT}
	CFLAGS+=-DCPU_AT91SAM9260
	CFLAGS+=-DLINUX -DIS_LITTLE_ENDIAN -D_GNU_SOURCE -D_REENTRANT -D_LARGE_THREADS -D_THREAD_SAFE
	LDFLAGS+=-ldl
	PLATOS=LINUX
endif

# ==================================
# ** ARCH SETTINGS FOR N300       **
# ==================================

TMP=${PLAT}
ifeq ($(TMP), N300)
	CROSS_COMPILE=arm-linux-uclibc-
	CONFIGURE_ARCH=--host=arm-linux --build=i386
	CFLAGS+=-DPLAT_N300
	CFLAGS+=-DARCH_${PLAT}
	CFLAGS+=-DCPU_AT91SAM9260
	CFLAGS+=-DLINUX -DIS_LITTLE_ENDIAN -D_GNU_SOURCE -D_REENTRANT -D_LARGE_THREADS -D_THREAD_SAFE
	LDFLAGS+=-ldl
	PLATOS=LINUX
endif



# ============================
# ** ARCH SETTINGS FOR I386 **
# ============================

TMP=${PLAT}
ifneq (,$(filter I386,$(TMP)))
	CROSS_COMPILE=
	CONFIGURE_ARCH=
	CFLAGS+=-DPLAT_PC
	CFLAGS+=-DARCH_$(PLAT)
	CFLAGS+=-DCPU_I386
	LDFLAGS+=-ldl
	CFLAGS+=-DLINUX -DIS_LITTLE_ENDIAN
	PLATOS=LINUX
endif

# Get alll the source code folder, all the source code in the subdir will be compiled and
# archive to a static library, named lib${subdir_name}.a
OBJFILES = $(patsubst %.c,%,$(wildcard *.c))
SUBSRCS = $(shell find . -maxdepth 1 -type d|sed -n 's/.\///p'|grep -v 'libs' \
		          |grep -v '.svn'|grep -v '.git'|grep -v 'include'|grep -v 'bin')

# Add the subdir compiled static library into LDFLAGS
LDFLAGS+=$(patsubst %,-L%,$(SUBSRCS)) 
#LDFLAGS+=$(patsubst %,-l%,$(SUBSRCS)) 
#LDFLAGS+=-lcore -lcomport -lhal -lcmlib_eeprom 
LDFLAGS+=-lcmlib_eeprom 
CFLAGS+=$(patsubst %,-I${TOP_PATH}/%,$(SUBSRCS))
CFLAGS+=-I$(TOP_PATH) 

export CC=${CROSS_COMPILE}gcc
export CXX=${CROSS_COMPILE}gcc
export AR=${CROSS_COMPILE}ar
export AS=${CROSS_COMPILE}as
export RANLIB=${CROSS_COMPILE}ranlib
export STRIP=${CROSS_COMPILE}strip
export PLATOS
export CONFIGURE_ARCH
export CFLAGS
export LDFLAGS
export PLAT 

#A function used to goes into the sub-folder to compile
MAKEFUNC = @MakeSubDir() \
    { \
        for DIR in ${SUBSRCS}; do \
            if [ -d $${DIR} ] ; then \
                cd $${DIR}; \
                MakeSubDir; \
                if [ -f makefile -o -f Makefile ]; then \
                    pwd; \
                    make $(1); \
                    if [ "$$?" != "0" ]; then \
                        exit 1; \
                    fi; \
                fi; \
                cd ..; \
            fi; \
        done; \
        if [ -f makefile -o -f Makefile ]; then \
            make $(1); \
            if [ "$$?" != "0" ]; then \
                exit 1; \
            fi; \
        fi; \
    }; \

MAKEME = cd $(2); MakeSubDir $(1); cd ..;
LOOPMAKEFUNC = $(MAKEFUNC) $(foreach dir,$(SUBSRCS),$(call MAKEME,$(1),$(dir)))

.PHONY: all

all: entry version binary
	@rm -f *.elf*
	@rm -f *.gdb
#	@cp ${APP_BINARY_NAME}  ${APP_BINARY_NAME}_svn${SVNVER}_$(ARCH)
#	@ake install


entry: clean
	@echo " ";
	@echo " =========================================================";
	@echo " ** Come into compile ${APP_BINARY_NAME} for ARCH $(ARCH) on $(PLATOS)";
	@echo " =========================================================";
	@echo " ";

version:
	@echo "/* Generated by makefile, don't Edit it by hand */" > version.h
	@echo "#define MAJOR ${MAJOR}" >>version.h
	@echo "#define MINOR ${MINOR}" >>version.h
	@echo "#define REVER ${REVER}" >>version.h
	@if [ -f .svn/entries ] ; then \
		echo "#define SVNVER `sed -n -e 11p .svn/entries`" >>version.h; \
	else \
		echo "#define SVNVER 0" >>version.h; \
	fi;

subdir:
	@$(call LOOPMAKEFUNC,all)
	@echo " ";
	@echo " =========================================================";
	@echo " ** Compile and linking ${APP_BINARY_NAME} for ${ARCH} now";
	@echo " =========================================================";

%: %.c
	$(CC) $< $(CFLAGS) -c -o $@.o

binary: subdir $(OBJFILES)
	$(CC) $(CFLAGS) -o $(APP_BINARY_NAME) *.o $(LDFLAGS) 
	
tag:
	@cscope -Rbq
	@ctags --c-kinds=+defglmnstuvx --langmap=c:.c.h.ho.hem.het.hec.hev.him.hit.hic.hiv -R .

install:
	sudo cp $(APP_BINARY_NAME) ${INST_PATH}

uninstall:
	rm -f ${INST_PATH}/$(APP_BINARY_NAME)

clean:
	@$(call LOOPMAKEFUNC,clean)
	@rm -f *.o $(APP_BINARY_NAME)
	@rm -f version.h
	@rm -f *.elf *.gdb

distclean: clean
	@$(call LOOPMAKEFUNC,distclean)

clear: distclean
	@rm -f tags  cscope*
	@rm -f  ${APP_BINARY_NAME}_svn*_*

